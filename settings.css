:root { --bg: #0b0f1a; --paper: #ffffff; --env: #f1f1f1; --shadow: rgba(0,0,0,.25); }
    * { box-sizing: border-box; }
    body{
      margin:0; height:100vh; display:flex; align-items:center; justify-content:center;
      background: radial-gradient(1200px 800px at 50% 30%, #1a2140 0%, var(--bg) 60%);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      overflow:hidden;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .hint{
      position:fixed; top:18px; left:0; right:0; text-align:center;
      font-size:14px; opacity:.75; color:#cdd6ff; padding:0 14px;
    }

    /* Stage container */
    .scene{
      width:min(360px, 92vw);
      height:min(520px, 86vh);
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .shell{
      position:absolute;
      inset:0;
      border-radius:18px;
      overflow:hidden;
      transform: translateZ(0);
    }

    .shell-back{ z-index: 1; }
    .shell-front{ z-index: 3; pointer-events:none; }

    /* Envelope wrapper */
    .envelope-wrap{
      width:min(320px, 84vw);
      height:220px;
      position:relative;
      filter: drop-shadow(0 18px 30px rgba(0,0,0,.25));
      cursor:pointer;
      transform: translateY(24px);
      will-change: transform;
    }

    /* Pulse while sealed */
    .stage-1 .envelope-wrap{
      animation: pulse 1.6s ease-in-out infinite;
    }
    @keyframes pulse{
      0%,100%{ transform: translateY(24px) scale(1); }
      50%{ transform: translateY(24px) scale(1.03); }
    }

    /* Envelope body */
    .env{
      position:absolute; inset:0;
      background: linear-gradient(180deg, #fbfbfb, #ececec);
      border-radius:18px;
      border: 1px solid rgba(0,0,0,.06);
    }

    /* Flap */
    .flap{
      position:absolute; left:-2px; right:-2px; top:-2px; height:62%;
      background: linear-gradient(180deg, #ffffff, #e9e9e9);
      transform-origin: top center;
      transform: rotateX(0deg);
      clip-path: polygon(0 0, 100% 0, 50% 88%);
      border-top-left-radius:18px;
      border-top-right-radius:18px;
      box-shadow: 0 10px 18px rgba(0,0,0,.08);
      will-change: transform;
    }

    /* Front triangles to look like envelope */
    .front-left, .front-right{
      position:absolute; bottom:0; width:50%; height:70%;
      background: linear-gradient(180deg, #f2f2f2, #e0e0e0);
      opacity:.98;
      transform: translateZ(0);
    }
    .front-left{
      left:0;
      clip-path: polygon(0 0, 100% 100%, 0 100%);
    }
    .front-right{
      right:0;
      clip-path: polygon(100% 0, 100% 100%, 0 100%);
    }
    .front-bottom{
      position:absolute; left:0; right:0; bottom:0; height:62%;
      background: linear-gradient(180deg, #f0f0f0, #dddddd);
      clip-path: polygon(0 0, 50% 72%, 100% 0, 100% 100%, 0 100%);
    }

    /* Letter (paper) */
    .letter{
      position:absolute;
      left:18px; right:18px;
      bottom:20px;
      z-index:2;
      height: 0px;
      background:
        linear-gradient(180deg, #ffffff, #f6f6ff),
        repeating-linear-gradient(
          0deg,
          rgba(17,24,39,.035) 0px,
          rgba(17,24,39,.035) 1px,
          rgba(17,24,39,0) 1px,
          rgba(17,24,39,0) 26px
        );
      border: 1px solid rgba(0,0,0,.06);
      border-radius: 14px;
      overflow:hidden;
      box-shadow: 0 10px 26px rgba(0,0,0,.18);
      transition:
        height 1100ms cubic-bezier(.2,.9,.2,1),
        transform 1100ms cubic-bezier(.2,.9,.2,1);
      transform: translateY(0px);
      cursor:pointer;
    }
    .letter-inner{
      padding: 22px 22px 26px;
      max-width: 42ch;
      margin: 0 auto;
      color:#111827;
      font-family: ui-serif, Georgia, "Times New Roman", Times, serif;
      line-height:1.65;
      font-size:16px;
      text-align:center;
      opacity:0;
      transition: opacity 400ms ease;
    }
    .letter-title{
      font-weight: 700;
      font-size: 18px;
      margin: 0 0 10px 0;
    }
    .letter-text{
      white-space: pre-wrap;
      margin:0;
      text-align:center;
    }

    /* Stage 2: envelope open + paper slides out (still "closed") */
    .stage-2 .flap{ transform: rotateX(165deg); }
    .stage-2 .letter{
      height: 170px;
      transform: translateY(-58px);
      transition-delay: 160ms;
    }
    .stage-2 .hint::after{ content:""; }

    /* Stage 4: paper unfolds and shows text */
    .stage-4 .letter--legacy{
      height: 440px;
      transform: translateY(-170px);
    }
    .stage-4 .letter-inner--legacy{ opacity:1; }

    /* Small “fold line” effect */
    .fold{
      position:absolute; left:0; right:0; top:46px; height:1px;
      background: rgba(0,0,0,.08);
    }

    .seal{
      position:absolute;
      left:50%;
      top:118px;                 /* можно чуть поднять/опустить */
      width:64px;
      height:64px;
      border-radius:50%;
      transform: translate(-50%,-50%);
      background:
        radial-gradient(circle at 30% 28%, rgba(255,255,255,.35), rgba(255,255,255,0) 42%),
        radial-gradient(circle at 70% 78%, rgba(0,0,0,.28), rgba(0,0,0,0) 56%),
        radial-gradient(circle at 30% 30%, #ff7a7a, #c81f2f 58%, #7a0c14 100%);
      box-shadow: 0 14px 26px rgba(0,0,0,.26), inset 0 2px 10px rgba(255,255,255,.22), inset 0 -10px 16px rgba(0,0,0,.18);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:6;
      will-change: transform, opacity;
    }

    /* Edge ridges like a real wax seal */
    .seal::before{
      content:"";
      position:absolute;
      inset:-7px;
      border-radius:50%;
      background: repeating-conic-gradient(from 8deg,
        #a31625 0 10deg,
        #c52334 10deg 20deg
      );
      -webkit-mask: radial-gradient(circle, transparent 60%, #000 61%);
      mask: radial-gradient(circle, transparent 60%, #000 61%);
      filter: blur(.2px);
      opacity:.92;
      pointer-events:none;
    }

    /* Inner ring + depth */
    .seal::after{
      content:"";
      position:absolute;
      inset:7px;
      border-radius:50%;
      box-shadow:
        inset 0 2px 5px rgba(255,255,255,.18),
        inset 0 -6px 10px rgba(0,0,0,.28);
      border: 1px solid rgba(255,255,255,.12);
      pointer-events:none;
    }

    .seal svg{
      width:28px; height:28px;
      display:block;
      fill: rgba(255,255,255,.18);
      filter:
        drop-shadow(0 -1px 0 rgba(0,0,0,.35))
        drop-shadow(0 1px 0 rgba(255,255,255,.20));
      transform: translateY(1px);
    }

    .seal .crack{
      position:absolute;
      width:44px;
      height:2px;
      background: rgba(255,255,255,.65);
      transform: rotate(-18deg);
      opacity:0;
      z-index:2;
    }

    /* первый клик: "распечатка" */
    @keyframes sealBreak {
      0%   { transform: translate(-50%,-50%) scale(1) rotate(0deg); opacity:1; }
      40%  { transform: translate(-50%,-50%) scale(1.08) rotate(6deg); opacity:1; }
      70%  { transform: translate(-50%,-40%) scale(.92) rotate(14deg); opacity:.9; }
      100% { transform: translate(-50%,-10%) scale(.25) rotate(22deg); opacity:0; }
    }
    @keyframes crackFlash{
      0%{opacity:0}
      35%{opacity:1}
      100%{opacity:0}
    }

    @keyframes unsealWiggle{
      0%{ transform: translateY(24px) rotate(0deg); }
      18%{ transform: translateY(24px) rotate(-2deg); }
      40%{ transform: translateY(24px) rotate(2.6deg); }
      62%{ transform: translateY(24px) rotate(-1.4deg); }
      82%{ transform: translateY(24px) rotate(.8deg); }
      100%{ transform: translateY(24px) rotate(0deg); }
    }

    @keyframes flapOpen{
      0%{ transform: rotateX(0deg); }
      70%{ transform: rotateX(175deg); }
      100%{ transform: rotateX(165deg); }
    }

    /* СТАДИИ */
    .stage-1 .envelope-wrap{ animation: pulse 1.6s ease-in-out infinite; }

    /* 1-й клик: распечатать + приоткрыть */
    .stage-2 .envelope-wrap{ animation: unsealWiggle 650ms ease-out both; }
    .stage-2 .seal{ animation: sealBreak 700ms cubic-bezier(.2,.9,.2,1) forwards; }
    .stage-2 .seal .crack{ animation: crackFlash 550ms ease forwards; }
    .stage-2 .flap{ animation: flapOpen 900ms cubic-bezier(.2,.9,.2,1) 120ms both; }

    /* на 1-м клике чуть вытаскиваем лист */
    .stage-2 .letter{
      height: 170px;
      transform: translateY(-58px);
      transition-delay: 160ms;
    }

    /* 2-й клик: лист вверх, конверт улетает вниз, лист занимает место */
    @keyframes letterOutThenSettle{
      0%   { transform: translateY(-58px); }
      45%  { transform: translateY(-300px); }
      100% { transform: translateY(-34px); }
    }

    @keyframes shellFlyUp{
      0%   { transform: translateY(0) rotate(0deg); opacity:1; }
      100% { transform: translateY(-420px) rotate(10deg); opacity:0; }
    }

    .stage-3 .shell{ animation: shellFlyUp 900ms cubic-bezier(.2,.9,.2,1) forwards; }
    .stage-3 .letter{
      animation: letterOutThenSettle 1100ms cubic-bezier(.2,.9,.2,1) forwards;
      left:10px;
      right:10px;
      border-radius:16px;
      height: 260px;            /* чтобы лист был “плотнее” после вылета */
    }

    /* 3-й клик (если хочешь): разворот письма и показ текста */
    .stage-4 .shell{
      opacity:0;
      transform: translateY(-420px) rotate(10deg);
      pointer-events:none;
    }
    .stage-4 .fold{ display:none; }
    .stage-4 .letter{
      position: fixed;
      left: 50%;
      top: 50%;
      right: auto;
      bottom: auto;
      width: min(520px, 92vw);
      height: min(640px, 86vh);
      transform: translate(-50%, -50%);
      border-radius:18px;
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .stage-4 .letter-inner{ opacity:1; }
    .stage-4 .letter-inner{
      position:relative;
      z-index:1;
      padding: 18px 20px 22px;
      font-size:17px;
      line-height:1.5;
      transform: scale(var(--letter-scale, 1));
      transform-origin: center;
    }

    .stage-4 .letter::before{
      content:"";
      position:absolute;
      left:18px;
      right:18px;
      top:50%;
      height:1px;
      background: linear-gradient(90deg, transparent, rgba(17,24,39,.10), transparent);
      box-shadow: 0 -10px 18px rgba(0,0,0,.04);
      z-index:0;
      pointer-events:none;
    }


    /* Prevent selecting */
    .no-select{ -webkit-user-select:none; user-select:none; }
